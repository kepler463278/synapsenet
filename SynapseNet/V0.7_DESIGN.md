# ðŸš€ SynapseNet v0.7 "Agent Toolchain" - Design Document

## Vision

**v0.6 gave nodes the ability to THINK. v0.7 gives them the ability to ACT.**

Nodes can now execute real-world tasks through tools (browser, APIs, file system, code execution) - safely, under policy control, with full traceability.

**Brain (v0.6) â†’ Body (v0.7)**

---

## Architecture Overview

```
Goal (v0.6)
    â†“
Plan (v0.6)
    â†“
Reasoning (v0.6)
    â†“
[NEW] Action Selection
    â†“
[NEW] Tool Execution (Sandboxed)
    â†“
[NEW] Result Validation
    â†“
Episode + Trace (v0.6)
    â†“
P2P Broadcast (v0.6)
```

---

## Core Modules

### 1. Agent Core (`crates/agent/src/agent_core.rs`)

**Responsibility:** Action execution loop

```rust
pub struct AgentCore {
    tool_registry: ToolRegistry,
    sandbox: Sandbox,
    reasoner: Reasoner,
}

impl AgentCore {
    pub async fn execute_goal(&self, goal_id: Uuid) -> Result<ActionTrace>;
}
```

**Flow:**
1. Get plan from Reasoner (v0.6)
2. For each task in plan:
   - Determine if tool needed
   - Select appropriate tool
   - Execute in sandbox
   - Validate result
   - Log to episode
3. Return complete trace

### 2. Tool API (`crates/agent/src/tool_api.rs`)

**Responsibility:** Unified tool interface

```rust
pub trait Tool: Send + Sync {
    fn name(&self) -> &'static str;
    fn description(&self) -> &'static str;
    fn schema(&self) -> ToolSchema;
    async fn execute(&self, input: ToolInput) -> Result<ToolOutput>;
}

pub struct ToolInput {
    pub params: serde_json::Value,
    pub context: ExecutionContext,
}

pub struct ToolOutput {
    pub result: serde_json::Value,
    pub metadata: ToolMetadata,
}
```

### 3. Tool Registry (`crates/agent/src/tool_registry.rs`)

**Responsibility:** Tool catalog and discovery

```rust
pub struct ToolRegistry {
    tools: HashMap<String, Box<dyn Tool>>,
    policies: HashMap<String, ToolPolicy>,
}

impl ToolRegistry {
    pub fn register(&mut self, tool: Box<dyn Tool>);
    pub fn get(&self, name: &str) -> Option<&dyn Tool>;
    pub fn list(&self) -> Vec<ToolInfo>;
    pub fn check_policy(&self, name: &str, context: &ExecutionContext) -> bool;
}
```

### 4. Sandbox (`crates/agent/src/sandbox.rs`)

**Responsibility:** Isolation and resource limits

```rust
pub struct Sandbox {
    cpu_limit_ms: u64,
    memory_limit_mb: u64,
    network_allowed: bool,
    file_access_path: PathBuf,
}

pub struct SandboxLimits {
    pub cpu_ms: u64,
    pub mem_mb: u64,
    pub max_steps: u32,
}

impl Sandbox {
    pub async fn execute<F, T>(&self, f: F) -> Result<T>
    where
        F: FnOnce() -> T + Send + 'static,
        T: Send + 'static;
}
```

---

## Official Tools

### 1. Web Fetch (`crates/tools_official/src/web_fetch.rs`)

**Purpose:** Safe HTTP requests with restrictions

**Features:**
- Whitelist/blacklist domains
- Rate limiting
- Content-type filtering
- Size limits
- Timeout enforcement

```rust
pub struct WebFetchTool {
    client: reqwest::Client,
    allowed_domains: Vec<String>,
    max_size_mb: u64,
}
```

### 2. Code Execution (`crates/tools_official/src/code_exec.rs`)

**Purpose:** Run code in isolated sandbox

**Features:**
- No system access
- Memory/CPU limits
- Language support: Python, JavaScript, Rust (WASM)
- Timeout enforcement

```rust
pub struct CodeExecTool {
    runtime: SandboxRuntime,
    languages: Vec<Language>,
}
```

### 3. File Operations (`crates/tools_official/src/file_ops.rs`)

**Purpose:** Read/write files in designated directory

**Features:**
- Restricted to `./capsule/work/`
- Size limits
- Extension filtering
- No symlinks

```rust
pub struct FileOpsTool {
    base_path: PathBuf,
    max_file_size_mb: u64,
}
```

### 4. Math Evaluation (`crates/tools_official/src/math_eval.rs`)

**Purpose:** Safe mathematical computations

**Features:**
- Symbolic math
- Numerical computation
- No arbitrary code execution

```rust
pub struct MathEvalTool {
    evaluator: MathEngine,
}
```

---

## Security Model

### Sandbox Constraints

```rust
pub const DEFAULT_LIMITS: SandboxLimits = SandboxLimits {
    cpu_ms: 200,
    mem_mb: 64,
    max_steps: 100,
};
```

### Tool Policies

```rust
pub struct ToolPolicy {
    pub enabled: bool,
    pub requires_approval: bool,
    pub rate_limit: Option<RateLimit>,
    pub allowed_contexts: Vec<String>,
}
```

### Action Logging

Every action is logged and signed:

```rust
pub struct ActionLog {
    pub id: Uuid,
    pub goal_id: Uuid,
    pub tool_name: String,
    pub input: ToolInput,
    pub output: ToolOutput,
    pub timestamp: i64,
    pub signature: String,
}
```

---

## Integration with v0.6

### Reasoner Extension

```rust
impl Reasoner {
    // NEW: Determine if action needed
    pub fn needs_action(&self, task: &Task) -> bool;
    
    // NEW: Select tool for task
    pub fn select_tool(&self, task: &Task) -> Option<String>;
}
```

### Episode Extension

```rust
pub struct Episode {
    // ... existing fields ...
    
    // NEW: Action trace
    pub actions: Vec<ActionLog>,
}
```

---

## API Extensions

### REST API v2.1

```
POST /v2/act                    # Execute action for goal
GET  /v2/act/trace/:goal_id     # Get action trace
GET  /v2/tools                  # List available tools
GET  /v2/tools/:name            # Get tool info
POST /v2/tools/:name/enable     # Enable tool
POST /v2/tools/:name/disable    # Disable tool
```

### CLI Commands

```bash
# Tool management
syn tools list
syn tools info <name>
syn tools enable <name>
syn tools disable <name>

# Action execution
syn act --goal <ID>
syn act trace --goal <ID>
syn act logs --goal <ID>
```

---

## Example Use Cases

### Use Case 1: Research Assistant

**Goal:** "Find smartphones under $300 with best reviews"

**Actions:**
1. `web_fetch` â†’ Search product reviews
2. `web_fetch` â†’ Get pricing data
3. `math_eval` â†’ Compare scores
4. Return ranked list with sources

### Use Case 2: Code Generator

**Goal:** "Create a Telegram bot that responds like me"

**Actions:**
1. Query local grains â†’ Extract personal style
2. `code_exec` â†’ Generate bot code
3. `file_ops` â†’ Save to file
4. Return bot code + instructions

### Use Case 3: Data Analysis

**Goal:** "Analyze CSV and find trends"

**Actions:**
1. `file_ops` â†’ Read CSV
2. `code_exec` â†’ Run analysis script
3. `math_eval` â†’ Statistical computations
4. Return insights + visualizations

---

## Performance Targets

- **Action execution:** < 500ms overhead
- **Sandbox startup:** < 100ms
- **Tool registry lookup:** < 1ms
- **Memory overhead:** < 50MB per action

---

## Implementation Phases

### Phase A: Core Infrastructure (3-5 days)
- Tool API trait
- Tool Registry
- Sandbox implementation
- Basic tests

### Phase B: Official Tools (4-6 days)
- WebFetchTool
- CodeExecTool
- FileOpsTool
- MathEvalTool
- Integration tests

### Phase C: Agent Core (3-7 days)
- AgentCore implementation
- Reasoner integration
- Episode extension
- End-to-end tests

### Phase D: API & CLI (2-4 days)
- REST API v2.1
- CLI commands
- Visual trace viewer
- Documentation

**Total: ~2-3 weeks**

---

## Database Schema Extension

```sql
-- Action logs table
CREATE TABLE IF NOT EXISTS action_logs (
    id TEXT PRIMARY KEY,
    goal_id TEXT NOT NULL,
    episode_id TEXT,
    tool_name TEXT NOT NULL,
    input_json TEXT NOT NULL,
    output_json TEXT NOT NULL,
    status TEXT NOT NULL,
    error TEXT,
    timestamp INTEGER NOT NULL,
    signature TEXT NOT NULL,
    FOREIGN KEY (goal_id) REFERENCES goals(id),
    FOREIGN KEY (episode_id) REFERENCES episodes(id)
);

-- Tool policies table
CREATE TABLE IF NOT EXISTS tool_policies (
    tool_name TEXT PRIMARY KEY,
    enabled INTEGER NOT NULL DEFAULT 1,
    requires_approval INTEGER NOT NULL DEFAULT 0,
    rate_limit_per_min INTEGER,
    allowed_contexts TEXT,
    updated_at INTEGER NOT NULL
);
```

---

## P2P Extensions

### New Message Types

```rust
pub enum ActionMessage {
    ToolRequest(ToolRequestMsg),
    ToolResponse(ToolResponseMsg),
    ActionShare(ActionShareMsg),
}
```

**Use cases:**
- Share successful action patterns
- Request tool execution from peers
- Broadcast tool discoveries

---

## PoE v3: Action Rewards

```rust
pub struct ActionReward {
    pub action_id: Uuid,
    pub tool_used: String,
    pub success: bool,
    pub novelty: f64,
    pub usefulness: f64,
    pub total_ngt: f64,
}
```

**Formula:**
```
total_ngt = base_reward * (success * 0.5 + novelty * 0.3 + usefulness * 0.2)
```

---

## Testing Strategy

### Unit Tests
- Tool trait implementations
- Sandbox isolation
- Registry operations
- Policy enforcement

### Integration Tests
- End-to-end action execution
- Multi-tool workflows
- Error handling
- Resource limits

### Security Tests
- Sandbox escape attempts
- Resource exhaustion
- Malicious input handling
- Policy bypass attempts

---

## Migration Path

**v0.6 â†’ v0.7:**
- Backward compatible
- Existing goals/episodes work unchanged
- Tools are opt-in
- Gradual rollout per node

---

## Success Metrics

- âœ… 4+ official tools working
- âœ… < 500ms action overhead
- âœ… 100% sandbox isolation
- âœ… Zero security incidents
- âœ… 50+ integration tests passing

---

**Status:** Design Complete  
**Next:** Phase A Implementation  
**Version:** 0.7.0-alpha  
**Date:** 2024-11-01

**Nodes can now ACT in the real world!** ðŸ¤–âœ¨
