# üöÄ SynapseNet v0.9 "On-Chain Economics" - Design Document

## Vision

**v0.8 gave nodes collective intelligence. v0.9 puts it ON-CHAIN with real economic incentives.**

Testnet with NGT token, PoE batches, staking/slashing, model registry, and grants - all verifiable on Cosmos blockchain.

**Off-Chain Intelligence (v0.5-v0.8) ‚Üí On-Chain Economics (v0.9)**

---

## Technology Stack

### Cosmos Ecosystem
- **CometBFT** - Byzantine fault-tolerant consensus
- **Cosmos SDK** - Blockchain framework
- **CosmWasm** - Smart contracts in Rust
- **wasmd** - WASM module for Cosmos

### Why Cosmos?
- ‚úÖ Rust-native smart contracts (CosmWasm)
- ‚úÖ Fast finality (~6s)
- ‚úÖ Low gas costs
- ‚úÖ Easy testnet deployment
- ‚úÖ Built-in IBC for cross-chain
- ‚úÖ Rich tooling (explorers, wallets)

---

## Architecture

```
SynapseNet Node (Off-Chain)
    ‚Üì
PoE Metrics Collection
    ‚Üì
Batch Aggregation (Merkle Root)
    ‚Üì
Multi-Signature
    ‚Üì
Submit to Cosmos Chain
    ‚Üì
CosmWasm Contracts:
  ‚îú‚îÄ poe_wasm (PoE batches + rewards)
  ‚îú‚îÄ stake_wasm (staking/slashing)
  ‚îú‚îÄ registry_wasm (models/tools)
  ‚îî‚îÄ grants_wasm (treasury/grants)
    ‚Üì
NGT Token Distribution
    ‚Üì
On-Chain Verification
```

---

## PoE Batch Structure

### Off-Chain Aggregation
```rust
pub struct PoeBatch {
    pub epoch: u64,
    pub chain_id: String,
    pub root: [u8; 32],              // Merkle root
    pub items: Vec<PoeItem>,         // Off-chain data
    pub participants: Vec<NodeId>,
    pub signers: Vec<PubKey>,
    pub sigs: Vec<Signature>,
}

pub struct PoeItem {
    pub node: NodeId,
    pub goal: Uuid,
    pub novelty: f32,
    pub coherence: f32,
    pub reuse: f32,
    pub weight: f32,
    pub leaf_hash: [u8; 32],
}
```

### Merkle Tree
```
leaf = hash(node || goal || novelty || coherence || reuse || weight)
root = merkle_root(all_leaves)
```

---

## Smart Contracts (CosmWasm)

### 1. PoE Contract (`poe_wasm`)

**Messages:**
```rust
pub struct InstantiateMsg {
    pub epoch_secs: u64,
    pub min_signers: u32,
    pub reward_per_epoch: Uint128,
}

pub enum ExecuteMsg {
    SubmitBatch {
        epoch: u64,
        root: Binary,
        participants: Vec<String>,
        signers: Vec<String>,
        sigs: Vec<Binary>,
    },
    ClaimReward {
        node: String,
    },
}

pub enum QueryMsg {
    GetEpoch { epoch: u64 },
    GetAccrual { node: String },
    GetConfig {},
}
```

**State:**
```rust
pub struct Config {
    pub epoch_secs: u64,
    pub min_signers: u32,
    pub reward_per_epoch: Uint128,
}

pub struct EpochAcc {
    pub root: [u8; 32],
    pub total_weight: Decimal,
    pub posted: bool,
}

// Storage
CONFIG: Item<Config>
EPOCHS: Map<u64, EpochAcc>
ACCRUAL: Map<&str, Uint128>  // node -> NGT debt
```

**Logic:**
1. Verify epoch not closed
2. Verify signatures (‚â• min_signers)
3. Store Merkle root
4. Calculate rewards: `reward * (node_weight / total_weight)`
5. Accrue to ACCRUAL map
6. ClaimReward mints/transfers NGT

### 2. Stake Contract (`stake_wasm`)

**Messages:**
```rust
pub enum ExecuteMsg {
    Bond { amount: Uint128 },
    Unbond { amount: Uint128 },
    Slash { node: String, amount: Uint128 },
}

pub enum QueryMsg {
    GetStake { node: String },
    GetTotalStaked {},
}
```

**State:**
```rust
STAKES: Map<&str, Uint128>
TOTAL_STAKED: Item<Uint128>
```

**Features:**
- Minimum stake for participation
- Unbonding period (e.g., 7 days)
- Slashing for misbehavior
- Stake weight in consensus

### 3. Registry Contract (`registry_wasm`)

**Messages:**
```rust
pub enum ExecuteMsg {
    PublishModel {
        model_id: String,
        sha256: String,
        license: String,
        meta_json: String,
    },
    PublishTool {
        tool_id: String,
        sha256: String,
        permissions: String,
        meta_json: String,
    },
}

pub enum QueryMsg {
    GetModel { model_id: String },
    GetTool { tool_id: String },
    ListModels { start_after: Option<String>, limit: Option<u32> },
}
```

**State:**
```rust
pub struct ModelEntry {
    pub model_id: String,
    pub sha256: String,
    pub license: String,
    pub publisher: String,
    pub stake: Uint128,
    pub timestamp: u64,
}

MODELS: Map<&str, ModelEntry>
TOOLS: Map<&str, ToolEntry>
```

**Requirements:**
- Minimum stake to publish
- SHA256 verification
- Immutable once published
- Searchable registry

### 4. Grants Contract (`grants_wasm`)

**Messages:**
```rust
pub enum ExecuteMsg {
    Propose {
        title: String,
        budget: Uint128,
        details: String,
    },
    Vote {
        proposal_id: u64,
        yes: bool,
    },
    Payout {
        proposal_id: u64,
        to: String,
    },
}

pub enum QueryMsg {
    GetProposal { id: u64 },
    ListProposals {},
}
```

**State:**
```rust
pub struct Proposal {
    pub id: u64,
    pub title: String,
    pub budget: Uint128,
    pub proposer: String,
    pub yes_votes: u64,
    pub no_votes: u64,
    pub status: ProposalStatus,
}

PROPOSALS: Map<u64, Proposal>
TREASURY: Item<Uint128>
```

**Governance:**
- Stake-weighted voting
- Quorum requirement
- Execution delay
- Treasury management

---

## Testnet Configuration

### Genesis Parameters
```toml
[chain]
chain_id = "synapsenet-testnet-1"
denom = "ungt"  # micro-NGT (1 NGT = 1,000,000 ungt)

[poe]
epoch_secs = 600  # 10 minutes
min_signers = 3
reward_per_epoch = 1000000000  # 1000 NGT

[stake]
min_stake = 100000000  # 100 NGT
unbonding_period = 604800  # 7 days

[registry]
min_publish_stake = 10000000  # 10 NGT

[grants]
quorum = 0.51  # 51%
execution_delay = 86400  # 1 day
```

### Validators
- 4 initial validators
- Minimum 3 signatures for PoE batches
- Validator set updates via governance

---

## Node Integration

### CLI Commands
```bash
# PoE batching
syn poe batch          # Collect local metrics
syn poe submit         # Submit to chain

# Staking
syn stake add 1000     # Stake 1000 NGT
syn stake remove 500   # Unbond 500 NGT
syn stake status       # Check stake

# Registry
syn models publish ./mistral.json
syn tools publish ./web_fetch.json
syn registry list

# Grants
syn grants propose "Build feature X" 5000
syn grants vote 1 yes
syn grants list
```

### Batch Submission Flow
```rust
// node/poe_batch/src/submit.rs

1. Collect local PoE metrics (v0.6-v0.8)
2. Aggregate into PoeBatch
3. Build Merkle tree
4. Get signatures from validators
5. Submit ExecuteMsg::SubmitBatch to chain
6. Wait for confirmation
7. ClaimReward when ready
```

---

## Docker Testnet

### Services
```yaml
services:
  chain:
    image: cosmwasm/wasmd:latest
    ports:
      - "26657:26657"  # RPC
      - "1317:1317"    # REST
      - "9090:9090"    # gRPC
  
  faucet:
    image: synapsenet/faucet
    environment:
      - CHAIN_RPC=http://chain:26657
  
  explorer:
    image: bigdipper/bigdipper
    ports:
      - "3000:3000"
```

### Initialization
```bash
./scripts/init-testnet.sh
  - Initialize chain
  - Create validator keys
  - Deploy contracts
  - Fund accounts
  - Start services
```

---

## Deployment Scripts

### `scripts/init-testnet.sh`
```bash
#!/bin/bash
# Initialize testnet
wasmd init synapsenet --chain-id synapsenet-testnet-1
wasmd keys add validator
wasmd add-genesis-account validator 1000000000000ungt
wasmd gentx validator 100000000ungt
wasmd collect-gentxs
wasmd start
```

### `scripts/deploy-contracts.sh`
```bash
#!/bin/bash
# Build and deploy contracts
cd chain/poe_wasm
cargo wasm
wasmd tx wasm store artifacts/poe_wasm.wasm --from validator
wasmd tx wasm instantiate 1 '{"epoch_secs":600,"min_signers":3,"reward_per_epoch":"1000000000"}' --from validator --label "poe"
```

---

## Documentation

### `docs/TESTNET.md`
- Setup instructions
- Faucet usage
- Validator operations
- Contract interaction

### `docs/POE_ONCHAIN.md`
- Batch format
- Reward formulas
- Epoch timing
- Merkle proofs

### `docs/REGISTRY.md`
- Publishing models
- Publishing tools
- Verification process
- Stake requirements

### `docs/GRANTS.md`
- Proposal process
- Voting mechanism
- Treasury management
- Payout execution

---

## Success Criteria

- ‚úÖ Local testnet running (4 validators)
- ‚úÖ 4 contracts deployed (poe, stake, registry, grants)
- ‚úÖ Node can submit PoE batch
- ‚úÖ NGT rewards distributed
- ‚úÖ Staking works (bond/unbond)
- ‚úÖ Model/tool published to registry
- ‚úÖ Grant proposal created and voted
- ‚úÖ Explorer showing transactions
- ‚úÖ Faucet distributing test tokens

---

## Implementation Phases

### Phase A: Contracts (5-7 days)
- poe_wasm contract
- stake_wasm contract
- registry_wasm contract
- grants_wasm contract
- Unit tests

### Phase B: Testnet (3-5 days)
- Docker compose setup
- Init scripts
- Deploy scripts
- Faucet service
- Explorer integration

### Phase C: Node Integration (4-6 days)
- PoE batch aggregation
- Merkle tree builder
- Chain submission
- CLI commands
- End-to-end tests

### Phase D: Documentation (2-3 days)
- Setup guides
- API documentation
- Examples
- Troubleshooting

**Total: ~2-3 weeks**

---

**Status:** Design Complete  
**Next:** Phase A Implementation  
**Version:** 0.9.0-alpha  
**Date:** 2024-11-01

**The network now has real economic incentives on-chain!** üí∞‚õìÔ∏è‚ú®
